var SECTIONS={REGISTERS:{sectionName:"registers",stopCharacters:["m","c"]},MEMORY:{sectionName:"memory",stopCharacters:["r","c"]},CODE:{sectionName:"code",stopCharacters:["r","m"]}},registers={},memory={},decodedCode=[],warnings=[];function canDoDragAndDrop(){var e=document.createElement("div");return("draggable"in e||"ondragstart"in e&&"ondrop"in e)&&"FormData"in window&&"FileReader"in window}function readDemoFile(){$.get("https://raw.githubusercontent.com/hunterhedges/mipsSimulator/master/sampleinputs/sample_1.txt",function(e){parseInputFile(e)})}function readFileOnUpload(e){var t;if("drop"==e.type?t=e.originalEvent.dataTransfer.files[0]:"change"==e.type&&(t=$("#file")[0].files[0]),t.type.includes("text")){var r=new FileReader;r.onload=function(e){var t=e.target.result;t.isNullOrEmpty()?showModal("Error Uploading File","File is empty"):parseInputFile(t)},r.readAsText(t)}else showModal("Error Uploading File","Incorrect file type")}function parseInputFile(e){reset(),loadRegisters(parseSection(e=e.toLowerCase(),SECTIONS.REGISTERS)),loadMemory(parseSection(e,SECTIONS.MEMORY)),loadDecodedCode(parseSection(e,SECTIONS.CODE)),displayDecodedInstructions(),displayWarnings()}function parseSection(e,t){var r,n="",s=0;if(e.includes(t.sectionName)){for(s=e.indexOf(t.sectionName)+t.sectionName.length;!t.stopCharacters.includes(e.charAt(s))&&s<e.length;)n+=e.charAt(s),s++;r=(r=n.split("\n")).removeEmptyElements()}else warnings.push("<strong>"+t.sectionName.toUpperCase()+"</strong> section not found in file.");return r}function loadRegisters(e){if(e)for(var t=0;t<e.length;t++){for(var r=0,n="",s="";" "!=e[t].charAt(r)&&r<e[t].length;)n+=e[t].charAt(r),r++;for(r+=1;r<e[t].length;r++)s+=e[t].charAt(r);"r"==n.charAt(0)&&(n=n.replace("r","")),isValidRegister(n)&&isValidValue(s)&&(s=parseInt(s),registers[n]=s)}}function isValidRegister(e){var t,r=!1;return(t=parseInt(e))||0==t?t>0&&t<32?r=!0:warnings.push("Register <strong>"+e+"</strong> must be between 1 and 31 inclusive."):warnings.push("Register <strong>"+e+"</strong> could not be parsed."),r}function loadMemory(e){if(e)for(var t=0;t<e.length;t++){for(var r=0,n="",s="";" "!=e[t].charAt(r)&&r<e[t].length;)n+=e[t].charAt(r),r++;for(r+=1;r<e[t].length;r++)s+=e[t].charAt(r);"m"==n.charAt(0)&&(n=n.replace("m","")),isValidMemoryLocation(n)&&isValidValue(s)&&(s=parseInt(s),memory[n]=s)}}function isValidMemoryLocation(e){var t,r=!1;return(t=parseInt(e))?t>=0&&t<65280&&t%4==0?r=!0:warnings.push("Memory location <strong>"+e+"</strong> must be greater than 0, less than 65280, and divisible by 4."):warnings.push("Memory location <strong>"+e+"</strong> could not be parsed."),r}function loadDecodedCode(e){if(e)for(var t=0;t<e.length;t++){e[t]=e[t].replace(/ /g,"");var r=findInstruction(e[t],ACTIONS.DECODE);r?(decodedCode.push(r),instructions.push(e[t])):warnings.push("Code <strong>"+e[t]+"</strong> is not a valid instruction.")}}function isValidValue(e){var t=!1;return(e=parseInt(e,10))||0==e?e<=4294967295&&e>=-2147483648?t=!0:warnings.push("Value <strong>"+e+"</strong> will result in overflow."):warnings.push("Value <strong>"+e+"</strong> could not be parsed."),t}function displayDecodedInstructions(){for(var e in $("#decodedInstructionsContainer").show(),$("#decodedInstructions").append("REGISTERS<br />"),registers)$("#decodedInstructions").append("R"+e+" "+registers[e]+"<br />");for(var e in 0==registers.length&&$("#decodedInstructions").append("All registers set to 0<br />"),$("#decodedInstructions").append("<br />"),$("#decodedInstructions").append("MEMORY<br />"),memory)$("#decodedInstructions").append(e+" "+memory[e]+"<br />");0==memory.length&&$("#decodedInstructions").append("All memory locations set to 0<br />"),$("#decodedInstructions").append("<br />"),$("#decodedInstructions").append("CODE<br />");for(var t=0;t<decodedCode.length;t++)$("#decodedInstructions").append(decodedCode[t]+"<br />");0==decodedCode.length&&$("#decodedInstructions").append("No code detected"),$("html, body").animate({scrollTop:$("#decodedInstructionsContainer").offset().top-20},500)}function displayWarnings(){if(0!=warnings.length){for(var e="",t=0;t<warnings.length;t++)e+=t+1+". "+warnings[t]+"<br />";showModal("Warnings",e)}}function showModal(e,t){$("#modalTitle").html(e),$("#modalBody").html(t),$("#modal").modal("show")}function reset(){$("#decodedInstructionsContainer").hide(),$("#decodedInstructions").html(""),$("#simulationResultsContainer").hide(),$("#simulationInstructions").html(""),$("#simulationRegisters").html(""),$("#simulationMemory").html(""),$("#simulationCycleData").html(""),registers={},memory={},decodedCode=[],warnings=[],instructions=[],registerStates=[],memoryStates=[],cycleData=[],pcCounter=0,cycleCounter=1,$("html, body").animate({scrollTop:0},500)}$(function(){canDoDragAndDrop||$("#dragDropAvailable").hide(),$("#uploadContainer").on("drag dragstart dragend dragover dragenter dragleave drop",function(e){e.preventDefault(),e.stopPropagation()}),$("#uploadContainer").on("dragenter dragover",function(){$("#uploadContainer").addClass("file-hover")}),$("#uploadContainer").on("dragleave dragend drop",function(){$("#uploadContainer").removeClass("file-hover")}),$("#uploadContainer").on("drop",readFileOnUpload),$("input[type='file']").change(readFileOnUpload),$("#uploadLink").on("click",function(e){e.preventDefault(),$("#file:hidden").trigger("click")})});var ACTIONS={DECODE:"decode",EXECUTE:"execute"};function ExecutionResult(e,t,r,n,s){this.stallAmount=e,this.registerState=t,this.memoryState=r,this.shouldBranch=n,this.branchOffset=s}function findInstruction(e,t){var r;switch((e=e.trim()).substring(0,6)){case"000000":var n=e.substring(26);"100000"==n?r=add(e,t):"100010"==n?r=sub(e,t):"101010"==n&&(r=setOnLessThan(e,t));break;case"001000":r=addi(e,t);break;case"000100":r=branchOnEqual(e,t);break;case"000101":r=branchNotEqual(e,t);break;case"100011":r=loadWord(e,t);break;case"101011":r=storeWord(e,t)}return r}function parseRs(e){var t=e.substring(6,11);return parseInt(t,2)}function parseRt(e){var t=e.substring(11,16);return parseInt(t,2)}function parseRd(e){var t=e.substring(16,21);return parseInt(t,2)}function parseOffset(e){var t=e.substring(16);return parseInt(t,2)}function parseImm(e){var t=e.substring(16);return t=uintToInt(t=parseInt(t,2),10)}function setRegisterDefault(e){registers[e]||(registers[e]=0)}function setMemoryDefault(e){memory[e]||(memory[e]=0)}function add(e,t){var r=parseRs(e),n=parseRt(e),s=parseRd(e);if(t==ACTIONS.DECODE)return"ADD R"+s+", R"+r+", R"+n;if(t==ACTIONS.EXECUTE){setRegisterDefault(r),setRegisterDefault(n);return new ExecutionResult(2,{register:s,value:registers[r]+registers[n]},null,!1,0)}}function addi(e,t){var r=parseRs(e),n=parseRt(e),s=parseImm(e);if(t==ACTIONS.DECODE)return"ADDI R"+n+", R"+r+", "+s;if(t==ACTIONS.EXECUTE){setRegisterDefault(r);return new ExecutionResult(2,{register:n,value:registers[r]+s},null,!1,0)}}function branchOnEqual(e,t){var r=parseRs(e),n=parseRt(e),s=parseOffset(e);if(t==ACTIONS.DECODE)return"BEQ R"+r+", R"+n+", "+s;if(t==ACTIONS.EXECUTE){setRegisterDefault(r),setRegisterDefault(n);var a=!1,o=0;return registers[r]==registers[n]&&(a=!0,o=s),new ExecutionResult(0,null,null,a,o)}}function branchNotEqual(e,t){var r=parseRs(e),n=parseRt(e),s=parseOffset(e);if(t==ACTIONS.DECODE)return"BNE R"+r+", R"+n+", "+s;if(t==ACTIONS.EXECUTE){setRegisterDefault(r),setRegisterDefault(n);var a=!1,o=0;return registers[r]!=registers[n]&&(a=!0,o=s),new ExecutionResult(0,null,null,a,o)}}function loadWord(e,t){var r=parseRs(e),n=parseRt(e),s=parseOffset(e);if(t==ACTIONS.DECODE)return"LW R"+n+", "+s+"(R"+r+")";if(t==ACTIONS.EXECUTE){setRegisterDefault(n),setRegisterDefault(r),setMemoryDefault(r+s);return new ExecutionResult(2,{register:n,value:memory[registers[r]+s]},null,!1,0)}}function storeWord(e,t){var r=parseRs(e),n=parseRt(e),s=parseOffset(e);if(t==ACTIONS.DECODE)return"SW R"+n+", "+s+"(R"+r+")";if(t==ACTIONS.EXECUTE){setRegisterDefault(n),setRegisterDefault(r),setMemoryDefault(r+s);return new ExecutionResult(0,null,{memoryLocation:registers[r]+s,value:registers[n]},!1,0)}}function setOnLessThan(e,t){var r=parseRs(e),n=parseRt(e),s=parseRd(e);if(t==ACTIONS.DECODE)return"SLT R"+s+", R"+r+", R"+n;if(t==ACTIONS.EXECUTE){setRegisterDefault(r),setRegisterDefault(n);return new ExecutionResult(2,registers[r]<registers[n]?{register:s,value:1}:{register:s,value:0},null,!1,0)}}function sub(e,t){var r=parseRs(e),n=parseRt(e),s=parseRd(e);if(t==ACTIONS.DECODE)return"SUB R"+s+", R"+r+", R"+n;if(t==ACTIONS.EXECUTE){setRegisterDefault(r),setRegisterDefault(n);return new ExecutionResult(2,{register:s,value:registers[r]-registers[n]},null,!1,0)}}var previousExecutionResult,instructions=[],registerStates=[],memoryStates=[],cycleData=[],currentStep=0,pcCounter=0,cycleCounter=1;function stepThrough(){"END"!=decodedCode[decodedCode.length-1]&&decodedCode.push("END"),simulationReset(),simulate(),$("#simulationResultsContainer").show(),displayInstructions(0),displayRegisters(0),displayMemory(0),displayCycleData(0),setDownloadLink(),$("#prevStepBtn").attr("disabled","disabled"),$("#nextStepBtn").removeAttr("disabled"),$("html, body").animate({scrollTop:$("#simulationResultsContainer").offset().top-20},500)}function nextStep(){displayInstructions(++currentStep),displayRegisters(currentStep),displayMemory(currentStep),displayCycleData(currentStep),currentStep==decodedCode.length-1&&$("#nextStepBtn").attr("disabled","disabled"),0!=currentStep&&$("#prevStepBtn").removeAttr("disabled")}function previousStep(){displayInstructions(--currentStep),displayRegisters(currentStep),displayMemory(currentStep),displayCycleData(currentStep),0==currentStep&&$("#prevStepBtn").attr("disabled","disabled"),currentStep!=decodedCode.length-1&&$("#nextStepBtn").removeAttr("disabled")}function executeAll(){"END"!=decodedCode[decodedCode.length-1]&&decodedCode.push("END"),simulationReset(),currentStep=decodedCode.length-1,simulate(),$("#simulationResultsContainer").show(),displayInstructions(decodedCode.length-1),displayRegisters(registerStates.length-1),displayMemory(memoryStates.length-1),displayCycleData(cycleData.length),setDownloadLink(),$("#nextStepBtn").attr("disabled","disabled"),$("#prevStepBtn").removeAttr("disabled"),$("html, body").animate({scrollTop:$("#simulationResultsContainer").offset().top-20},500)}function displayInstructions(e){$("#simulationInstructions").html("");for(var t=0;t<decodedCode.length;t++)t==e?$("#simulationInstructions").append("<tr><td>&rarr;</td><td>"+decodedCode[t]+"</td></tr>"):$("#simulationInstructions").append("<tr><td></td><td>"+decodedCode[t]+"</td></tr>")}function displayRegisters(e){for(var t in $("#simulationRegisters").html(""),registerStates[e])registerStates[e][t]&&$("#simulationRegisters").append("<tr><td>R"+t+"</td><td>"+registerStates[e][t]+"</td></tr>")}function displayMemory(e){for(var t in $("#simulationMemory").html(""),memoryStates[e])memoryStates[e][t]&&$("#simulationMemory").append("<tr><td>"+t+"</td><td>"+memoryStates[e][t]+"</td></tr>")}function displayCycleData(e){$("#simulationCycleNumber").html(""),$("#simulationCycleData").html(""),$("#clockCycleTitle").attr("colspan",cycleCounter);for(var t=1;t<cycleCounter;t++)$("#simulationCycleNumber").append("<td>"+t+"</td>");for(t=0;t<e;t++){$("#simulationCycleData").append("<tr>");for(var r=1;r<cycleCounter;r++)r<cycleData[t].length&&cycleData[t][r]?$("#simulationCycleData").append("<td>"+cycleData[t][r]+"</td>"):$("#simulationCycleData").append("<td></td>");$("#simulationCycleData").append("</tr>")}}function simulate(){for(registerStates.push(Object.assign({},registers)),memoryStates.push(Object.assign({},memory));pcCounter<instructions.length;){var e=decodeAndExecute(instructionFetch());e?(previousExecutionResult=e,writeMemory(e),writeBack(e),pcCounter++,cycleCounter-=4):previousExecutionResult=null}cycleCounter+=4}function instructionFetch(){return cycleData.push([]),cycleData[pcCounter][cycleCounter]="I"+(pcCounter+1)+"-IF",cycleCounter++,instructions[pcCounter]}function decodeAndExecute(e){if(previousExecutionResult&&(stall(previousExecutionResult.stallAmount),previousExecutionResult.shouldBranch))return pcCounter+=previousExecutionResult.branchOffset,cycleCounter++,memoryStates.push(Object.assign({},memoryStates[memoryStates.length-1])),void registerStates.push(Object.assign({},registerStates[registerStates.length-1]));cycleData[pcCounter][cycleCounter]="I"+(pcCounter+1)+"-ID",cycleCounter++;var t=findInstruction(e,ACTIONS.EXECUTE);return cycleData[pcCounter][cycleCounter]="I"+(pcCounter+1)+"-EX",cycleCounter++,t}function writeMemory(e){if(e.memoryState){var t=Object.assign({},memory),r=e.memoryState.memoryLocation,n=e.memoryState.value;t[r]=n,memoryStates.push(t),memory[r]=n}else memoryStates.push(Object.assign({},memoryStates[memoryStates.length-1]));cycleData[pcCounter][cycleCounter]="I"+(pcCounter+1)+"-MEM",cycleCounter++}function writeBack(e){if(e.registerState){var t=Object.assign({},registers),r=e.registerState.register,n=e.registerState.value;t[r]=n,registerStates.push(t),registers[r]=n}else registerStates.push(Object.assign({},registerStates[registerStates.length-1]));cycleData[pcCounter][cycleCounter]="I"+(pcCounter+1)+"-WB",cycleCounter++}function stall(e){for(var t=0;t<e;t++)cycleData[pcCounter][cycleCounter]="I"+(pcCounter+1)+"-stall",cycleCounter++}function simulationReset(){0!=registerStates.length&&(registers=registerStates[0]),0!=memoryStates.length&&(memory=memoryStates[0]),registerStates=[],memoryStates=[],cycleData=[],currentStep=0,pcCounter=0,cycleCounter=1,previousExecutionResult=null}function setDownloadLink(){for(var e="",t=1;t<cycleCounter;t++){e+="c#"+t;for(var r=0;r<cycleData.length;r++)cycleData[r][t]&&(e+=" "+cycleData[r][t]);e+="\n"}for(var n in e+="REGISTERS\n",registerStates[registerStates.length-1])0!=registerStates[registerStates.length-1][n]&&(e+="R"+n+" "+registerStates[registerStates.length-1][n]+"\n");for(var n in e+="MEMORY\n",memoryStates[memoryStates.length-1])0!=memoryStates[memoryStates.length-1][n]&&(e+=n+" "+memoryStates[memoryStates.length-1][n]+"\n");var s="data:application/octet-stream;charset=utf-8;base64,"+btoa(e);$("#downloadLink").attr("href",s)}function uintToInt(e,t){return e<<=32-(t=+t||32),e>>=32-t}Array.prototype.removeEmptyElements=function(){for(var e=[],t=0;t<this.length;t++)this[t].isNullOrEmpty()||e.push(this[t]);return e},String.prototype.isNullOrEmpty=function(){return!this||/^\s*$/.test(this)};
